$(function(){if(!Gobal.IsWeixin){$(".m-block-header").show()}var i=$("#cartBody");var k=$("#divNone");var a=$("#mycartpay");var c=a.children("dl").children("dt").find("em");var b=$(c[1]);var g=$(c[0]);var h=parseInt($("#hidUserID").val());var j=h>0?true:false;var d=$("#a_payment");var f=null;var l=function(){$.cookie("_FastBuy",null);var A=$("#i_buynext");if($.cookie("_AutoNext")!=0){A.addClass("checked")}var q=new $CartComm();var r=function(L,F,G,E,N){var H=255;var K=126;if(typeof(E)!="undefined"){H=E}if(typeof(E)!="undefined"){K=N}var M=null;var O='<div class="clearfix m-round u-tipsEject"><div class="u-tips-txt">'+L+'</div><div class="u-Btn"><div class="u-Btn-li"><a href="javascript:;" id="btnMsgCancel" class="z-CloseBtn">取消</a></div><div class="u-Btn-li"><a id="btnMsgOK" href="javascript:;" class="z-DefineBtn">确定</a></div></div></div>';var J=function(){var P=$("#pageDialog");P.find("a.z-DefineBtn").click(function(){if(typeof(F)!="undefined"&&F!=null){F()}I.close()});P.find("a.z-CloseBtn").click(function(){if(typeof(G)!="undefined"&&G!=null){G()}I.cancel()})};var I=new $.PageDialog(O,{W:H,H:K,close:true,autoClose:false,ready:J})};var D=function(H,G,F,E){$.PageDialog.fail(H,G,F,E)};var t=function(F){var E=function(I,J,G){var H=new RegExp(J,"g");return I.replace(H,G)};var F=escape(F);F=E(F,"\\+","%2B");F=E(F,"/","%2F");return F};var x=function(){var E=A.hasClass("checked")?1:0;location.href=Gobal.WxDomain+"/"+Gobal.SiteVer+"/passport/login.do?forward="+t(Gobal.WxDomain+"/"+Gobal.SiteVer+"/mycart/payment.do?bx="+E)};var z=0;var C=null;var v=function(G,E,J,F){if(G!=3||E<=0){return""}var H="";var I=J-F;if(E<I){H="剩余"+E+"人次，最多可参与"+E+"人次"}else{if(F==0){}else{if(F<J){H="您已参与"+F+"人次，最多可参与"+I+"人次"}}}return H};var y=function(){$("div.footer").hide();a.css("bottom","0px");var S=$(this);var L=S.attr("id");var O=L.replace("txtNum","");var E=$("#oldshopNum"+O);var G=parseInt($("#suplus"+O).val());var R=G;var K=parseInt($("#codeType"+O).val());var H=(K==3)?true:false;var F=0;var J=0;if(H){F=parseInt($("#limitBuyNum"+O).val());J=parseInt($("#haveBuyNum"+O).val());var T=F-J;if(G>T){G=T}}var I,Q,N=/^[1-9]{1}\d{0,6}$/;var M;var P=function(){I=E.val();Q=S.val();if(I!=Q){var V=$(window).width();var U=(V)/2-S.offset().left-255/2;if(Q==""){return}if(N.test(Q)){M=parseInt(Q);if(M<=G){E.val(Q)}else{M=G;if(H){var W=v(K,R,F,J);if(W!=""){D(W,S,-70,U)}}else{D("最多参与"+M+"人次",S,-70,U)}S.val(M);E.val(M)}n(S,O,M);u();p(S,M,G);m(M,S)}else{D("只能输正整数哦",S,-70,U);S.val(I)}}};C=setInterval(P,200)};var B=function(K,F){var E=parseInt($("#suplus"+K).val());var H=parseInt($("#codeType"+K).val());if(H==3){var J=parseInt($("#limitBuyNum"+K).val());var G=parseInt($("#haveBuyNum"+K).val());var I=J-G;if(E>I){E=I}}else{if(F<=0){F=1}}if(F>E){F=E}return F};var w=function(){$("div.footer").show();a.css("bottom","49px");if(C!=null){clearInterval(C)}var I=$(this);var G=I.attr("id");var F=G.replace("txtNum","");var E=parseInt($("#oldshopNum"+F).val());var H=parseInt(I.val());if(isNaN(H)||I.val()==""){H=E}else{if(E==H){return}}I.val(B(F,H))};var n=function(E,G,F){q.updateShopCart(G,F,function(H){})};var o=function(E){E.removeClass("active");E[0].offsetWidth=E[0].offsetWidth;E.addClass("active")};var s=function(G,N){var K=N.attr("id");var M=K.replace("txtNum","");var H=parseInt($("#suplus"+M).val());var I=parseInt($("#codeType"+M).val());if(I==3){var F=parseInt($("#limitBuyNum"+M).val());var J=parseInt($("#haveBuyNum"+M).val());var O=F-J;if(H>O){H=O}}var E=$("#oldshopNum"+M);var L=parseInt(E.val())+G;if(L>0&&L<=H){p(N,L,H);o(N);E.val(L);N.val(L);m(L,N);n(N,M,L);u()}};var p=function(F,H,G){var E=F.prev();var I=F.next();if(G==1){E.addClass("dis");I.addClass("dis")}else{if(H==1){E.addClass("dis");I.removeClass("dis")}else{if(H==G){E.removeClass("dis");I.addClass("dis")}else{E.removeClass("dis");I.removeClass("dis")}}}};var m=function(F,I){var H=I.parent().parent().parent();var E=H.find("div.z-Cart-tips");if(F>100){if(E.length==0){var G=$('<div class="z-Cart-tips">已超过100人次，云购存在一定风险，请谨慎参与！</div>');H.prepend(G)}}else{E.remove()}};var u=function(){var E=0;var F=0;$("input[name=num]",i).each(function(I){var H=$(this).attr("id");var G=H.replace("txtNum","");var K=parseInt($("#codeState"+G).val());if(K!=1){return false}var J=parseInt($(this).val());if(!isNaN(J)){F++;E+=J}});b.html(F);g.html("<span>￥</span>"+CastMoney(E));if(F==0&&E==0){a.hide()}};q.getShopCart(function(R){if(R.code==0){var K=R.listCart;var L=R.listUpdate;var M=R.listOutDate;z=R.money;if(R.count>0){a.show()}a.find("em").eq(0).html("<span>￥</span>"+R.money+".00");a.find("em").eq(1).html(R.count);var F="";if(K.length>0){for(var J=0;J<K.length;J++){var E=K[J];var P=E.codeQuantity-E.codeSales;var O=E.codeType==3;var H=P;var Q=false;var N=0;if(O){N=E.codeLimitBuy-E.myLimitSales;Q=N==0?true:false;H=N>P?P:N}F+="<li>";F+='<a class="fl u-Cart-img" href="/'+Gobal.SiteVer+"/product/"+E.codeID+'.do">';F+='<img src="https://skin.1yyg.net/'+Gobal.SiteVer+'/weixin/images/loading2.gif" src2="https://img.1yyg.net/GoodsPic/pic-200-200/'+E.goodsPic+'" border="0" alt="">';if(O){F+='<div class="pTitle pPurchase">限购</div>'}F+="</a>";F+='<div class="u-Cart-r">';F+='<a href="/'+Gobal.SiteVer+"/product/"+E.codeID+'.do" class="gray6">(第'+E.codePeriod+"云)"+E.goodsName+"</a>";F+='<span class="gray9">';F+="<em>剩余"+P+"人次</em>";if(O){if(Q){F+='<br/><em class="gray9" style="margin: 0;">限购'+E.codeLimitBuy+"人次，您已参与"+E.myLimitSales+"人次</em>"}else{F+='<em>&nbsp;/&nbsp;</em><em class="gray9" style="margin: 0;">限购'+E.codeLimitBuy+"人次</em>"}}F+="</span>";if(H>0){F+='<div class="num-opt">';F+='<em class="num-mius'+(E.shopNum==1?" dis":"")+'"><i></i></em>';F+='<input id="txtNum'+E.codeID+'" name="num" maxlength="6" type="text" value="'+E.shopNum+'" codeID="'+E.codeID+'" />';F+='<em class="num-add'+(E.shopNum>=H?" dis":"")+'"><i></i></em>';F+="</div>"}F+='<a href="javascript:;" name="delLink" cid="'+E.codeID+'" class="z-del"><s></s></a>';F+="</div>";if(H>0){F+='<input id="oldshopNum'+E.codeID+'" type="hidden" value="'+E.shopNum+'" />';F+='<input id="suplus'+E.codeID+'" type="hidden" value="'+P+'" />';F+='<input id="limitBuyNum'+E.codeID+'" type="hidden" value="'+E.codeLimitBuy+'" />';F+='<input id="haveBuyNum'+E.codeID+'" type="hidden" value="'+E.myLimitSales+'" />';F+='<input id="codeType'+E.codeID+'" type="hidden" value="'+E.codeType+'" />';F+='<input id="codeState'+E.codeID+'" type="hidden" value="1" />'}F+="</li>"}}if(L.length>0){for(var J=0;J<L.length;J++){var E=L[J];var P=E.codeQuantity-E.codeSales;var O=E.codeType==3;var H=P;var Q=false;var N=0;if(O){N=E.codeLimitBuy-E.myLimitSales;Q=N==0?true:false;H=N>P?P:N}F+="<li>";F+='<a class="fl u-Cart-img" href="/'+Gobal.SiteVer+"/product/"+E.codeID+'.do">';F+='<img src="https://skin.1yyg.net/'+Gobal.SiteVer+'/weixin/images/loading2.gif" src2="https://img.1yyg.net/GoodsPic/pic-200-200/'+E.goodsPic+'" border="0" alt="">';if(O){F+='<div class="pTitle pPurchase">限购</div>'}F+="</a>";F+='<div class="u-Cart-r">';F+='<a href="/'+Gobal.SiteVer+"/product/"+E.codeID+'.do" class="gray6">(已更新至第'+E.codePeriod+"云)"+E.goodsName+"</a>";F+='<span class="gray9">';F+="<em>剩余"+P+"人次</em>";if(O){if(Q){F+='<br/><em class="gray9" style="margin: 0;">限购'+E.codeLimitBuy+"人次，您已参与"+E.myLimitSales+"人次</em>"}else{F+='<em>&nbsp;/&nbsp;</em><em class="gray9" style="margin: 0;">限购'+E.codeLimitBuy+"人次</em>"}}F+="</span>";if(H>0){F+='<div class="num-opt">';F+='<em class="num-mius'+(E.shopNum==1?" dis":"")+'"><i></i></em>';F+='<input id="txtNum'+E.codeID+'" name="num"  maxlength="6" type="text" value="'+E.shopNum+'" codeID="'+E.codeID+'" />';F+='<em class="num-add'+(E.shopNum>=H?" dis":"")+'"><i></i></em>';F+="</div>"}F+='<a href="javascript:;" name="delLink" cid="'+E.codeID+'" isover="0" class="z-del"><s></s></a>';F+="</div>";if(H>0){F+='<input id="oldshopNum'+E.codeID+'" type="hidden" value="'+E.shopNum+'" />';F+='<input id="suplus'+E.codeID+'" type="hidden" value="'+P+'" />';F+='<input id="limitBuyNum'+E.codeID+'" type="hidden" value="'+E.codeLimitBuy+'" />';F+='<input id="haveBuyNum'+E.codeID+'" type="hidden" value="'+E.myLimitSales+'" />';F+='<input id="codeType'+E.codeID+'" type="hidden" value="'+E.codeType+'" />';F+='<input id="codeState'+E.codeID+'" type="hidden" value="1" />'}F+="</li>"}}F+="</div>";if(M.length>0){for(var J=0;J<M.length;J++){var E=M[J];F+='<li class="m-list-shelves">';F+='<a class="fl u-Cart-img" href="/'+Gobal.SiteVer+"/products/"+E.goodsID+'.do">';F+='<img src="https://skin.1yyg.net/'+Gobal.SiteVer+'/weixin/images/loading2.gif" src2="https://img.1yyg.net/GoodsPic/pic-200-200/'+E.goodsPic+'" border="0" alt="">';F+="</a>";F+='<div class="u-Cart-r">';F+='<a href="/'+Gobal.SiteVer+"/products/"+E.goodsID+'.do" class="gray6">'+E.goodsName+"</a>";F+='<a href="javascript:;" name="delLink" cid="'+E.codeID+'" isover="1" class="z-del"><s></s></a>';F+='<div class="tip">已结束</div>';F+="</div>";F+="</li>"}}var G=$(F);i.html(G);loadImgFun();G.find("a[name='delLink']").bind("click",function(){var T=$(this);var S=function(){q.delShopCart(U,function(V){if(V.code==0){T.parent().parent().remove();e(false);u()}else{D("删除失败，请重试["+V.code+"]")}})};var U=T.attr("cid");if(T.attr("isover")=="1"){S()}else{r("您确定要删除吗？",S)}});$("input[name=num]",i).each(function(S){var U=$(this);var T=U.val();m(T,U);U.bind("focus",y).bind("blur",w).bind("touchstart",function(){$("div.footer").hide();a.css("bottom","0px")});U.prev().bind("click",function(){s(-1,U)});U.next().bind("click",function(){s(1,U)})});A.click(function(){if($(this).hasClass("checked")){$(this).removeClass("checked");$.cookie("_AutoNext",0,{domain:"1yyg.com",path:"/"})}else{$(this).addClass("checked");$.cookie("_AutoNext",1,{domain:"1yyg.com",path:"/"})}}).next().click(function(){$(this).prev().trigger("click")}).next().click(function(){var S='<div class="g-an-dialog">';S+='<div class="g-an-con">';S+="<h6>温馨提示</h6>";S+="<p>热门商品可能会瞬间抢光哦，此处勾选后系统将会自动为您参与最新一云！</p>";S+='<a href="javascript:;" class="orange-btn">确认</a>';S+="</div>";S+="</div>";var U=function(){var V=$("#pageDialog");V.find("a.orange-btn").click(function(){T.close()})};var T=new $.PageDialog(S,{W:280,H:248,close:true,autoClose:false,ready:U})});d.bind("click",function(){if(z==0){D("对不起，购物车中没有商品！");return}var T=A.hasClass("checked")?1:0;q.getShopCart(function(U){if(U.code==0){K=U.listCart;L=U.listUpdate;M=U.listOutDate;if(K.length==0&&L.length==0){r("您的购物车中所有商品已失效！",function(){$.cookie("_CartData_"+h,null,{domain:"1yyg.com",path:"/",expires:7});$.cookie("_CartDataSel",null,{domain:"1yyg.com",path:"/",expires:1});location.reload()},function(){location.reload()},300)}else{if(M.length>0&&T==0){r("部分商品已失效，继续云购？",function(){if(L.length>0){r("部分商品失效已更新到最新一云，继续云购？",function(){S()},function(){location.reload()},300)}else{S()}},function(){location.reload()},300)}else{if(L.length>0&&T==0){r("部分商品失效已更新到最新一云，继续云购？",function(){S()},function(){location.reload()},300)}else{S()}}}}});var S=function(){var X="",aa="";if(K.length>0){for(var V=0;V<K.length;V++){var U=K[V];var W=U.codeQuantity-U.codeSales;var Y=W;if(U.codeType==3){var Z=U.codeLimitBuy-U.myLimitSales;Y=Z>W?W:Z}if(Y>0){X+=K[V].codeID+",";aa+=K[V].shopNum+","}}}if(L.length>0){for(var V=0;V<L.length;V++){var U=L[V];var W=U.codeQuantity-U.codeSales;var Y=W;if(U.codeType==3){var Z=U.codeLimitBuy-U.myLimitSales;Y=Z>W?W:Z}if(Y>0){X+=L[V].codeID+",";aa+=L[V].shopNum+","}}}if(X==""||aa==""){D("对不起，没有购买的商品！");return}X=X.substring(0,X.length-1);aa=aa.substring(0,aa.length-1);q.setSelValue(X,aa,function(){location.href="/"+Gobal.SiteVer+"/mycart/Payment.do?bx="+T})}});if($.cookie("_autoBuyTipWx")!="1"){var I=$('<div class="g-auto-nextWrapper"><div class="g-auto-nextip"></div></div>');I.click(function(){$.cookie("_autoBuyTipWx","1",{expires:100});I.remove()});$("div.wrapper").append(I)}}else{e(true)}});FastClick.attach(document.body)};var e=function(p){$("body").addClass("g-acc-bg");var n=$("li",i);if(n.length<1){i.empty();a.hide();k.html("");if(j=="1"){k.append('<s></s><p>主银，您的购物车还是空的哦~</p><a href="'+Gobal.WxDomain+'" class="orangeBtn">立即去云购</a>').show();window.GuessListBox.webRender($("#mycartpay"),"before",location.href)}else{k.append("<s></s><p>如果您还未登录，可能导致购物车为空</p><a href="+Gobal.WxDomain+"/"+Gobal.SiteVer+"/Passport/login.do?forward="+encodeURIComponent("/"+Gobal.SiteVer+"/MyCart/index.do")+'" class="orangeBtn">立即登录</a>').show();window.GuessListBox.webPushRender($("#mycartpay"),"before",location.href)}$("div.footer").show().find("#btnCart").addClass("hover").find("i").html("");$("body").removeClass("g-acc-bg");$("div.g-Cart-list").css({"margin-bottom":"0px"})}else{if(!p){var o=$("div.footer").find("#btnCart").find("b");var m=parseInt(o.attr("num"))-1;if(m<100){o.attr("num",m).removeClass("tomore").html(m)}}}};Base.getScript(Gobal.Skin+"/JS/pageDialog.js?v=160606",function(){Base.getScript(Gobal.Skin+"/JS/fastclick.js?v=160606",l)})});